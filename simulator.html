<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbytt - Crypto Market Cap Simulator</title>
    <link rel="icon" type="image/jpeg" href="IMG_1011.jpeg">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="dark-mode">
    <div id="globalLoader" class="global-loader">
        <div class="loader-circle"></div>
    </div>

    <header>
        <div class="header-content">
            <a href="index.html" style="text-decoration: none; color: inherit;">
                <h1>
                    <div class="logo-wrapper">
                        <img src="IMG_1011.jpeg" alt="Orbytt" class="logo-icon">
                        <!-- Fallback SVG logo -->
                        <svg class="logo-svg" width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="display:none;">
                            <ellipse cx="16" cy="16" rx="14" ry="10" fill="currentColor"/>
                            <ellipse cx="16" cy="16" rx="8" ry="5" fill="var(--bg-primary)"/>
                            <path d="M 28 12 Q 30 16 28 20" fill="none" stroke="var(--bg-primary)" stroke-width="2"/>
                        </svg>
                    </div>
                    Orbytt
                </h1>
            </a>
            <nav class="nav-tabs">
                <a href="simulator.html" class="nav-tab active">
                    <i class="fas fa-calculator"></i>
                    Simulator
                </a>
                <a href="portfolio.html" class="nav-tab">
                    <i class="fas fa-briefcase"></i>
                    Portfolio
                </a>
            </nav>
            <button id="themeToggle" class="theme-toggle">
                <i class="fas fa-sun"></i>
            </button>
        </div>
    </header>

    <main>
        <section class="page active">
            <div class="simulator-container">
                <div class="simulator-header">
                    <h2>Market Cap Simulator</h2>
                    <p>Calculate what a cryptocurrency's price would be at another coin's market cap</p>
                </div>

                <div class="simulator-content">
                    <div class="comparison-grid">
                        <div class="crypto-selector">
                            <label>Coin X</label>
                            <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" id="simCoin1Search" placeholder="Search coin..." autocomplete="off">
                            </div>
                            <div id="simCoin1Dropdown" class="coin-dropdown"></div>
                            <div id="sim1Selected" class="selected-coin-display"></div>
                        </div>

                        <div class="crypto-selector">
                            <label>Coin Y</label>
                            <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" id="simCoin2Search" placeholder="Search coin..." autocomplete="off">
                            </div>
                            <div id="simCoin2Dropdown" class="coin-dropdown"></div>
                            <div id="sim2Selected" class="selected-coin-display"></div>
                        </div>
                    </div>

                    <button id="swapButton" class="btn-secondary">
                        <i class="fas fa-exchange-alt"></i>
                        Swap
                    </button>

                    <button id="calculateButton" class="btn-primary btn-large">
                        <i class="fas fa-calculator"></i>
                        Calculate Price
                    </button>

                    <div id="simulatorResults" class="simulator-results"></div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // FAIL-PROOF SIMULATOR WITH MULTIPLE API SOURCES
        let cryptoList = [];
        let selectedSimCoin1 = null;
        let selectedSimCoin2 = null;
        let coinDataCache = {};

        async function initApp() {
            showGlobalLoader();
            try {
                await loadCryptoList();
                setupSimulator();
                setupThemeToggle();
                hideGlobalLoader();
                console.log('✓ App initialized successfully');
            } catch (error) {
                hideGlobalLoader();
                console.error('Init failed:', error);
                alert("Failed to load. Please refresh the page.");
            }
        }

        function showGlobalLoader() {
            const loader = document.getElementById('globalLoader');
            if (loader) loader.style.display = 'flex';
        }

        function hideGlobalLoader() {
            const loader = document.getElementById('globalLoader');
            if (loader) loader.style.display = 'none';
        }

        async function loadCryptoList() {
            // Try CoinGecko first
            try {
                console.log('Loading from CoinGecko...');
                const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&page=1&sparkline=false', {
                    signal: AbortSignal.timeout(10000)
                });
                if (response.ok) {
                    cryptoList = await response.json();
                    console.log(`✓ Loaded ${cryptoList.length} coins from CoinGecko`);
                    return;
                }
            } catch (error) {
                console.warn('CoinGecko failed:', error.message);
            }

            // Fallback to CoinCap
            try {
                console.log('Loading from CoinCap...');
                const response = await fetch('https://api.coincap.io/v2/assets?limit=250', {
                    signal: AbortSignal.timeout(10000)
                });
                if (response.ok) {
                    const data = await response.json();
                    cryptoList = data.data.map(coin => ({
                        id: coin.id.toLowerCase(),
                        symbol: coin.symbol.toLowerCase(),
                        name: coin.name,
                        image: `https://assets.coincap.io/assets/icons/${coin.symbol.toLowerCase()}@2x.png`,
                        current_price: parseFloat(coin.priceUsd),
                        market_cap: parseFloat(coin.marketCapUsd)
                    }));
                    console.log(`✓ Loaded ${cryptoList.length} coins from CoinCap`);
                    return;
                }
            } catch (error) {
                console.warn('CoinCap failed:', error.message);
            }

            // Last resort: hardcoded top coins
            console.warn('Using hardcoded data');
            cryptoList = [
                {id: "bitcoin", symbol: "btc", name: "Bitcoin", current_price: 43000, market_cap: 840000000000, image: "https://assets.coincap.io/assets/icons/btc@2x.png"},
                {id: "ethereum", symbol: "eth", name: "Ethereum", current_price: 2300, market_cap: 276000000000, image: "https://assets.coincap.io/assets/icons/eth@2x.png"},
                {id: "tether", symbol: "usdt", name: "Tether", current_price: 1, market_cap: 91000000000, image: "https://assets.coincap.io/assets/icons/usdt@2x.png"},
                {id: "binancecoin", symbol: "bnb", name: "BNB", current_price: 310, market_cap: 47600000000, image: "https://assets.coincap.io/assets/icons/bnb@2x.png"},
                {id: "solana", symbol: "sol", name: "Solana", current_price: 98, market_cap: 42000000000, image: "https://assets.coincap.io/assets/icons/sol@2x.png"},
                {id: "ripple", symbol: "xrp", name: "XRP", current_price: 0.52, market_cap: 28000000000, image: "https://assets.coincap.io/assets/icons/xrp@2x.png"},
                {id: "cardano", symbol: "ada", name: "Cardano", current_price: 0.38, market_cap: 13300000000, image: "https://assets.coincap.io/assets/icons/ada@2x.png"},
                {id: "dogecoin", symbol: "doge", name: "Dogecoin", current_price: 0.08, market_cap: 11400000000, image: "https://assets.coincap.io/assets/icons/doge@2x.png"},
                {id: "polkadot", symbol: "dot", name: "Polkadot", current_price: 5.20, market_cap: 6700000000, image: "https://assets.coincap.io/assets/icons/dot@2x.png"},
                {id: "chainlink", symbol: "link", name: "Chainlink", current_price: 14.50, market_cap: 8100000000, image: "https://assets.coincap.io/assets/icons/link@2x.png"}
            ];
        }

        async function fetchCoinData(coinId) {
            // Check cache (5 min expiry)
            const cached = coinDataCache[coinId];
            if (cached && (Date.now() - cached.timestamp < 300000)) {
                console.log(`Using cached data for ${coinId}`);
                return cached.data;
            }

            // Try CoinGecko
            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}`, {
                    signal: AbortSignal.timeout(8000)
                });
                if (response.ok) {
                    const data = await response.json();
                    coinDataCache[coinId] = { data, timestamp: Date.now() };
                    console.log(`✓ Fetched ${coinId} from CoinGecko`);
                    return data;
                }
            } catch (error) {
                console.warn(`CoinGecko failed for ${coinId}`);
            }

            // Fallback: estimate from list data
            const coinFromList = cryptoList.find(c => c.id === coinId);
            if (coinFromList && coinFromList.market_cap && coinFromList.current_price) {
                const estimatedSupply = coinFromList.market_cap / coinFromList.current_price;
                return {
                    id: coinFromList.id,
                    symbol: coinFromList.symbol,
                    name: coinFromList.name,
                    image: { large: coinFromList.image },
                    market_data: {
                        current_price: { usd: coinFromList.current_price },
                        market_cap: { usd: coinFromList.market_cap },
                        circulating_supply: estimatedSupply
                    }
                };
            }

            throw new Error(`No data for ${coinId}`);
        }

        async function calculateSimulation() {
            const resultsDiv = document.getElementById('simulatorResults');
            
            if (!selectedSimCoin1 || !selectedSimCoin2) {
                alert('Please select both cryptocurrencies');
                return;
            }

            resultsDiv.innerHTML = `
                <div class="empty-state">
                    <div class="loader-circle"></div>
                    <p>Calculating...</p>
                </div>
            `;

            try {
                // Retry logic
                let data1, data2;
                for (let attempt = 0; attempt < 3; attempt++) {
                    try {
                        [data1, data2] = await Promise.all([
                            fetchCoinData(selectedSimCoin1.id),
                            fetchCoinData(selectedSimCoin2.id)
                        ]);
                        break;
                    } catch (error) {
                        if (attempt === 2) throw error;
                        console.log(`Retry ${attempt + 1}...`);
                        await new Promise(r => setTimeout(r, 1000));
                    }
                }

                const coin1Supply = data1.market_data.circulating_supply;
                const coin1Price = data1.market_data.current_price.usd;
                const coin2MarketCap = data2.market_data.market_cap.usd;

                if (!coin1Supply || coin1Supply === 0) {
                    resultsDiv.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>Missing Supply Data</p>
                            <span>${selectedSimCoin1.name} supply not available</span>
                        </div>
                    `;
                    return;
                }

                const newPrice = coin2MarketCap / coin1Supply;
                const change = ((newPrice / coin1Price) - 1) * 100;
                const multiplier = newPrice / coin1Price;

                resultsDiv.innerHTML = `
                    <div class="result-card">
                        <div class="result-label">
                            ${data1.symbol.toUpperCase()} at ${data2.symbol.toUpperCase()}'s market cap
                        </div>
                        <div class="result-price">$${formatNumber(newPrice)}</div>
                        <div class="result-change" style="color: ${change >= 0 ? '#22c55e' : '#ef4444'}">
                            ${change >= 0 ? '↑' : '↓'} ${Math.abs(change).toFixed(2)}%
                        </div>
                        <div class="result-stats">
                            <div class="result-stat">
                                <div class="result-stat-label">Current Price</div>
                                <div class="result-stat-value">$${formatNumber(coin1Price)}</div>
                            </div>
                            <div class="result-stat">
                                <div class="result-stat-label">Multiplier</div>
                                <div class="result-stat-value">${multiplier.toFixed(2)}x</div>
                            </div>
                        </div>
                    </div>
                `;

                console.log('✓ Calculation successful!');

            } catch (error) {
                console.error('Calculation failed:', error);
                resultsDiv.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Unable to Calculate</p>
                        <span>All data sources failed. Try again shortly.</span>
                    </div>
                `;
            }
        }

        function formatNumber(num) {
            if (isNaN(num) || num === null) return "0.00";
            if (num >= 1000000000) return (num / 1000000000).toFixed(2) + "B";
            if (num >= 1000000) return (num / 1000000).toFixed(2) + "M";
            if (num >= 1000) return (num / 1000).toFixed(2) + "K";
            if (num >= 1) return num.toFixed(2);
            if (num >= 0.01) return num.toFixed(4);
            if (num >= 0.0001) return num.toFixed(6);
            return num.toFixed(8);
        }

        function setupSimulator() {
            setupSearch('simCoin1Search', 'simCoin1Dropdown', 'sim1Selected', 1);
            setupSearch('simCoin2Search', 'simCoin2Dropdown', 'sim2Selected', 2);

            const calcBtn = document.getElementById('calculateButton');
            const swapBtn = document.getElementById('swapButton');

            if (calcBtn) calcBtn.addEventListener('click', calculateSimulation);
            if (swapBtn) swapBtn.addEventListener('click', swapCoins);
        }

        function setupSearch(inputId, dropdownId, displayId, coinNum) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);

            if (!input || !dropdown) return;

            input.addEventListener('input', () => {
                const value = input.value.toLowerCase().trim();
                dropdown.innerHTML = '';

                if (!value) {
                    dropdown.classList.remove('active');
                    return;
                }

                const matches = cryptoList.filter(coin =>
                    coin.name.toLowerCase().includes(value) ||
                    coin.symbol.toLowerCase().includes(value)
                ).slice(0, 15);

                if (matches.length === 0) {
                    dropdown.innerHTML = '<div class="dropdown-item disabled">No results</div>';
                } else {
                    matches.forEach(coin => {
                        const div = document.createElement('div');
                        div.className = 'dropdown-item';
                        div.innerHTML = `
                            <img src="${coin.image}" class="coin-icon" alt="${coin.name}">
                            <span>${coin.name} (${coin.symbol.toUpperCase()})</span>
                        `;
                        div.onclick = () => selectCoin(coin, coinNum, input, dropdown, displayId);
                        dropdown.appendChild(div);
                    });
                }

                dropdown.classList.add('active');
            });

            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            });
        }

        function selectCoin(coin, coinNum, input, dropdown, displayId) {
            if (coinNum === 1) selectedSimCoin1 = coin;
            else selectedSimCoin2 = coin;

            input.value = '';
            dropdown.classList.remove('active');

            const display = document.getElementById(displayId);
            if (display) {
                display.innerHTML = `
                    <img src="${coin.image}" alt="${coin.name}">
                    <div class="coin-details">
                        <div class="coin-name">${coin.name} (${coin.symbol.toUpperCase()})</div>
                        <div class="coin-price">$${formatNumber(coin.current_price)}</div>
                    </div>
                `;
                display.classList.add('active');
            }
        }

        function swapCoins() {
            const temp = selectedSimCoin1;
            selectedSimCoin1 = selectedSimCoin2;
            selectedSimCoin2 = temp;

            ['sim1Selected', 'sim2Selected'].forEach((id, i) => {
                const coin = i === 0 ? selectedSimCoin1 : selectedSimCoin2;
                const display = document.getElementById(id);
                
                if (coin && display) {
                    display.innerHTML = `
                        <img src="${coin.image}" alt="${coin.name}">
                        <div class="coin-details">
                            <div class="coin-name">${coin.name} (${coin.symbol.toUpperCase()})</div>
                            <div class="coin-price">$${formatNumber(coin.current_price)}</div>
                        </div>
                    `;
                    display.classList.add('active');
                } else if (display) {
                    display.classList.remove('active');
                }
            });

            document.getElementById('simulatorResults').innerHTML = '';
        }

        function setupThemeToggle() {
            const button = document.getElementById('themeToggle');
            if (!button) return;

            const body = document.body;
            const savedTheme = localStorage.getItem('theme') || 'dark';

            if (savedTheme === 'light') body.classList.remove('dark-mode');
            else body.classList.add('dark-mode');

            updateThemeIcon();

            button.addEventListener('click', () => {
                body.classList.toggle('dark-mode');
                const isDark = body.classList.contains('dark-mode');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                updateThemeIcon();
            });
        }

        function updateThemeIcon() {
            const button = document.getElementById('themeToggle');
            const isDark = document.body.classList.contains('dark-mode');
            if (button) button.innerHTML = `<i class="fas fa-${isDark ? 'sun' : 'moon'}"></i>`;
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>